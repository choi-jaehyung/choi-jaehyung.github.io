<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fairtoon - 웹툰 불법 유통 근절 캠페인</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel CDN (JSX 변환용) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; }
        .modal-enter { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #2563eb; cursor: pointer;
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <!-- Fix: data-type="module"을 추가하여 import 구문을 지원합니다 -->
    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const { useState, useEffect, useMemo, useRef } = React;

        // --- Firebase 설정 ---
        // 만약 본인의 웹사이트에 업로드할 때 데이터가 안 나온다면, 
        // 본인의 Firebase Console에서 받은 config 객체로 이 부분을 교체하세요.
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'fairtoon-campaign';

        // 아이콘 헬퍼 컴포넌트
        const Icon = ({ name, className = "", size = 24, fill = "none" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (iconRef.current && window.lucide) {
                    window.lucide.createIcons({
                        icons: { [name]: window.lucide.icons[name] },
                        attrs: { class: className, width: size, height: size, fill: fill, stroke: "currentColor" }
                    });
                }
            }, [name, className, size, fill]);
            return <i ref={iconRef} data-lucide={name}></i>;
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [signatures, setSignatures] = useState([]);
            const [messages, setMessages] = useState([]);
            const [viewCount, setViewCount] = useState(10);
            const [formData, setFormData] = useState({ name: '', school: '', region: '서울', message: '' });
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [toast, setToast] = useState(null);

            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
                onAuthStateChanged(auth, setUser);
            }, []);

            useEffect(() => {
                if (!user) return;
                const sigRef = collection(db, 'artifacts', appId, 'public', 'data', 'signatures');
                const msgRef = collection(db, 'artifacts', appId, 'public', 'data', 'messages');

                onSnapshot(sigRef, (s) => setSignatures(s.docs.map(d => ({id: d.id, ...d.data()}))));
                onSnapshot(msgRef, (s) => {
                    const data = s.docs.map(d => ({id: d.id, ...d.data()}));
                    setMessages(data.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)));
                });
            }, [user]);

            const stats = useMemo(() => ({
                total: signatures.length,
                regionStats: signatures.reduce((acc, c) => ({...acc, [c.region]: (acc[c.region] || 0) + 1}), {}),
                schoolStats: signatures.reduce((acc, c) => ({...acc, [c.school]: (acc[c.school] || 0) + 1}), {})
            }), [signatures]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!user || isSubmitting) return;
                setIsSubmitting(true);
                try {
                    const ts = serverTimestamp();
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'signatures'), {
                        ...formData, timestamp: ts
                    });
                    if (formData.message) {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
                            name: formData.name, text: formData.message, timestamp: ts
                        });
                    }
                    setFormData({ name: '', school: '', region: '서울', message: '' });
                    setToast("서명이 완료되었습니다!");
                    setTimeout(() => setToast(null), 3000);
                } catch (err) { console.error(err); } finally { setIsSubmitting(false); }
            };

            return (
                <div className="min-h-screen text-slate-900 pb-20">
                    {toast && (
                        <div className="fixed top-20 left-1/2 -translate-x-1/2 z-[100] bg-blue-600 text-white px-8 py-3 rounded-full shadow-xl font-bold animate-bounce">
                            {toast}
                        </div>
                    )}

                    <nav className="bg-white/80 backdrop-blur-md border-b sticky top-0 z-50 px-6 h-16 flex items-center justify-between">
                        <div className="flex items-center gap-2 font-black text-2xl text-blue-600">
                            <Icon name="Heart" className="text-pink-500" fill="currentColor" />
                            <span>Fairtoon</span>
                        </div>
                        <div className="flex gap-4">
                            <a href="#sign" className="bg-blue-600 text-white px-5 py-2 rounded-full font-bold">서명하기</a>
                        </div>
                    </nav>

                    <header className="bg-gradient-to-br from-blue-600 to-indigo-800 text-white py-24 text-center px-6">
                        <h1 className="text-5xl font-black mb-6">불법 웹툰 이용 근절,<br /><span className="text-yellow-300">Fairtoon</span>이 함께합니다.</h1>
                        <p className="text-xl opacity-90 mb-12">당신의 정당한 감상이 작가님의 내일을 만듭니다.</p>
                        <div className="flex justify-center gap-6">
                            <div className="bg-white/10 p-6 rounded-2xl border border-white/20">
                                <p className="text-sm opacity-70">현재 서명 인원</p>
                                <p className="text-3xl font-bold">{stats.total.toLocaleString()}명</p>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-4xl mx-auto px-6 mt-20 space-y-24">
                        <section id="calc" className="bg-white p-10 rounded-3xl shadow-sm border">
                            <h2 className="text-2xl font-bold mb-8 flex items-center gap-2"><Icon name="Calculator" className="text-blue-600" /> 나의 소비 습관 피해 계산기</h2>
                            <div className="space-y-6">
                                <p className="text-slate-600">한 달 동안 불법 사이트에서 본 웹툰은 총 몇 회인가요?</p>
                                <input type="range" min="0" max="100" value={viewCount} onChange={e => setViewCount(e.target.value)} className="w-full h-2 bg-slate-100 rounded-lg appearance-none cursor-pointer" />
                                <div className="flex justify-between items-center bg-slate-50 p-6 rounded-2xl">
                                    <span className="font-bold text-slate-500">{viewCount}회 시청 시</span>
                                    <span className="text-3xl font-black text-red-500">약 ₩{(viewCount * 300).toLocaleString()} 피해</span>
                                </div>
                            </div>
                        </section>

                        <section id="sign" className="grid grid-cols-1 md:grid-cols-2 gap-10">
                            <div className="bg-slate-900 text-white p-10 rounded-3xl">
                                <h2 className="text-2xl font-bold mb-6 flex items-center gap-2"><Icon name="PenTool" className="text-blue-400" /> 캠페인 동참 서명</h2>
                                <form onSubmit={handleSubmit} className="space-y-4 text-slate-900">
                                    <input required placeholder="이름" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full p-4 rounded-xl outline-none" />
                                    <input required placeholder="학교명" value={formData.school} onChange={e => setFormData({...formData, school: e.target.value})} className="w-full p-4 rounded-xl outline-none" />
                                    <select value={formData.region} onChange={e => setFormData({...formData, region: e.target.value})} className="w-full p-4 rounded-xl outline-none bg-white">
                                        {['서울','경기','인천','충청','전라','경상','강원','제주'].map(r => <option key={r} value={r}>{r}</option>)}
                                    </select>
                                    <textarea placeholder="작가님께 한마디" value={formData.message} onChange={e => setFormData({...formData, message: e.target.value})} className="w-full p-4 rounded-xl outline-none h-24" />
                                    <button type="submit" disabled={isSubmitting} className="w-full bg-blue-500 text-white font-bold py-4 rounded-xl hover:bg-blue-400 transition">약속하고 서명하기</button>
                                </form>
                            </div>
                            <div className="space-y-4">
                                <h3 className="text-xl font-bold flex items-center gap-2"><Icon name="Send" className="text-blue-600" /> 최근 참여 메시지</h3>
                                <div className="h-[450px] overflow-y-auto space-y-3 pr-2">
                                    {messages.map((m, i) => (
                                        <div key={i} className="bg-white p-5 rounded-2xl border shadow-sm">
                                            <div className="flex justify-between text-xs mb-2">
                                                <span className="font-bold text-blue-600">{m.name} ({m.school})</span>
                                                <span className="text-slate-400">{m.region}</span>
                                            </div>
                                            <p className="text-sm text-slate-600">{m.text || "서명에 동참했습니다!"}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </section>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
